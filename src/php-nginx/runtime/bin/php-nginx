#!/usr/bin/env bash

set -e
set -u

source "$RUNTIME_INC_DIR/bash-functions"

TRAPPED_SIGNAL=false

NGINX_PID_FILE=$RUNTIME_RUN_DIR/nginx.pid
FPM_PID_FILE=$RUNTIME_RUN_DIR/php-fpm.pid

function terminate()
{
  TRAPPED_SIGNAL=true
  kill -15 "$(cat "$NGINX_PID_FILE")"
  kill -15 "$(cat "$FPM_PID_FILE")"
}

info "Starting PHP-FPM service..."
/usr/sbin/php-fpm &> /dev/null
FPM_PID=$(cat "$FPM_PID_FILE")

info "Starting Nginx service..."
/usr/sbin/nginx &> /dev/null
NGINX_PID=$(cat "$NGINX_PID_FILE")

info "PHP-FPM is running with PID $FPM_PID"
info "Nginx is running with PID $NGINX_PID"

trap "terminate" SIGTERM  SIGINT

while :
do
    NGINX_PID=$(cat "$NGINX_PID_FILE")
    kill -0 "$NGINX_PID" 2> /dev/null
    NGINX_STATUS=$?

    FPM_PID=$(cat "$FPM_PID_FILE")
    kill -0 "$FPM_PID" 2> /dev/null
    FPM_STATUS=$?

    if [ "$TRAPPED_SIGNAL" = "false" ]; then
        if [ $NGINX_STATUS -ne 0 ] || [ $FPM_STATUS -ne 0 ]; then
            if [ $NGINX_STATUS -eq 0 ]; then
                kill -15 "$NGINX_PID";
                wait "$NGINX_PID";
            fi

            if [ $FPM_STATUS -eq 0 ]; then
                kill -15 "$FPM_PID";
                wait "$FPM_PID";
            fi

            exit 1;
        fi
    else
       if [ $NGINX_STATUS -ne 0 ] && [ $FPM_STATUS -ne 0 ]; then
            exit 0;
       fi
    fi

	  sleep 1
done
