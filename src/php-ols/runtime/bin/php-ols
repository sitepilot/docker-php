#!/usr/bin/env bash

set -e
set -u

source "$RUNTIME_INC_DIR/bash-functions"

TRAPPED_SIGNAL=false

OLS_PID_FILE=/tmp/lshttpd/lshttpd.pid
FPM_PID_FILE=$RUNTIME_RUN_DIR/php-fpm.pid

function terminate()
{
  TRAPPED_SIGNAL=true
  kill -15 "$(cat "$OLS_PID_FILE")"
  kill -15 "$(cat "$FPM_PID_FILE")"
}

info "Starting PHP-FPM service..."
/usr/sbin/php-fpm &> /dev/null
FPM_PID=$(cat "$FPM_PID_FILE")

info "Starting OpenLiteSpeed service..."
/usr/local/lsws/bin/lswsctrl start &> /dev/null
OLS_PID=$(cat "$OLS_PID_FILE")

info "PHP-FPM is running with PID $FPM_PID"
info "OpenLiteSpeed is running with PID $OLS_PID"

trap "terminate" SIGTERM  SIGINT

while :
do
    OLS_PID=$(cat "$OLS_PID_FILE")
    kill -0 "$OLS_PID" 2> /dev/null
    OLS_STATUS=$?

    FPM_PID=$(cat "$FPM_PID_FILE")
    kill -0 "$FPM_PID" 2> /dev/null
    FPM_STATUS=$?

    if [ "$TRAPPED_SIGNAL" = "false" ]; then
        if [ $OLS_STATUS -ne 0 ] || [ $FPM_STATUS -ne 0 ]; then
            if [ $OLS_STATUS -eq 0 ]; then
                kill -15 "$OLS_PID";
                wait "$OLS_PID";
            fi

            if [ $FPM_STATUS -eq 0 ]; then
                kill -15 "$FPM_PID";
                wait "$FPM_PID";
            fi

            exit 1;
        fi
    else
       if [ $OLS_STATUS -ne 0 ] && [ $FPM_STATUS -ne 0 ]; then
            exit 0;
       fi
    fi

	  sleep 1
done
